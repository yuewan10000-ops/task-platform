# æœåŠ¡å™¨éƒ¨ç½²æ­¥éª¤

## âœ… å·²å®Œæˆ
- [x] ä»£ç å·²æ¨é€åˆ° GitHubï¼šhttps://github.com/yuewan10000-ops/task-platform

## ğŸš€ æœåŠ¡å™¨éƒ¨ç½²æ­¥éª¤

### 1. SSH ç™»å½•æœåŠ¡å™¨

```bash
ssh root@64.176.83.204
```

### 2. å…‹éš†ä»“åº“

```bash
# è¿›å…¥ /opt ç›®å½•
cd /opt

# å…‹éš†ä»“åº“
git clone https://github.com/yuewan10000-ops/task-platform.git

# è¿›å…¥é¡¹ç›®ç›®å½•
cd task-platform
```

### 3. å®‰è£…åç«¯ä¾èµ–

```bash
cd backend
npm install
```

### 4. å®‰è£…å‰ç«¯ä¾èµ–

```bash
# A-portal
cd ../frontend/a-portal
npm install

# B-portal
cd ../b-portal
npm install
```

### 5. é…ç½®ç¯å¢ƒå˜é‡

```bash
# è¿›å…¥åç«¯ç›®å½•
cd /opt/task-platform/backend

# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp env.example .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡
nano .env
```

**éœ€è¦é…ç½®çš„å†…å®¹ï¼š**
```env
DATABASE_URL="mysql://task_user:ä½ çš„æ•°æ®åº“å¯†ç @localhost:3306/task_db"
JWT_SECRET="ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ä½œä¸ºJWTå¯†é’¥"
ADMIN_ACCOUNT="admin"
ADMIN_LOGIN_PASSWORD="ä½ çš„ç®¡ç†å‘˜ç™»å½•å¯†ç "
ADMIN_PAY_PASSWORD="ä½ çš„ç®¡ç†å‘˜æ”¯ä»˜å¯†ç "
```

**ä¿å­˜å¹¶é€€å‡ºï¼š** `Ctrl+X` â†’ `Y` â†’ `Enter`

### 6. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
cd /opt/task-platform/backend

# ç”Ÿæˆ Prisma Client
npx prisma generate

# è¿è¡Œæ•°æ®åº“è¿ç§»
npx prisma migrate deploy
```

### 7. æ„å»ºé¡¹ç›®

```bash
# æ„å»ºåç«¯
cd /opt/task-platform/backend
npm run build

# æ„å»ºå‰ç«¯ A-portal
cd /opt/task-platform/frontend/a-portal
npm run build

# æ„å»ºå‰ç«¯ B-portal
cd /opt/task-platform/frontend/b-portal
npm run build
```

### 8. å¯åŠ¨åç«¯æœåŠ¡ï¼ˆä½¿ç”¨ PM2ï¼‰

```bash
# å®‰è£… PM2ï¼ˆå¦‚æœè¿˜æ²¡å®‰è£…ï¼‰
npm install -g pm2

# å¯åŠ¨æœåŠ¡
cd /opt/task-platform/backend
pm2 start dist/server.js --name task-platform-api

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs task-platform-api

# ä¿å­˜ PM2 é…ç½®
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
# æ‰§è¡Œä¸Šé¢å‘½ä»¤è¾“å‡ºçš„å‘½ä»¤ï¼ˆé€šå¸¸æ˜¯ sudo env PATH=...ï¼‰
```

### 9. é…ç½® Nginx

ç¡®ä¿ Nginx é…ç½®æ­£ç¡®ï¼š

**A-portal é…ç½®ï¼š**
```nginx
server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºä½ çš„åŸŸåæˆ–IP

    root /opt/task-platform/frontend/a-portal/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

**B-portal é…ç½®ï¼š**
```nginx
server {
    listen 8080;  # ä½¿ç”¨ä¸åŒç«¯å£
    server_name your-domain.com;

    root /opt/task-platform/frontend/b-portal/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

**åº”ç”¨é…ç½®ï¼š**
```bash
# ç¼–è¾‘ Nginx é…ç½®
sudo nano /etc/nginx/sites-available/default

# æˆ–è€…åˆ›å»ºæ–°é…ç½®
sudo nano /etc/nginx/sites-available/task-platform

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½ Nginx
sudo systemctl reload nginx
```

### 10. éªŒè¯éƒ¨ç½²

1. **æ£€æŸ¥åç«¯æœåŠ¡ï¼š**
   ```bash
   pm2 status
   curl http://localhost:3000/api/health  # å¦‚æœæœ‰å¥åº·æ£€æŸ¥æ¥å£
   ```

2. **æ£€æŸ¥å‰ç«¯ï¼š**
   - è®¿é—®ï¼š`http://ä½ çš„æœåŠ¡å™¨IP`ï¼ˆA-portalï¼‰
   - è®¿é—®ï¼š`http://ä½ çš„æœåŠ¡å™¨IP:8080`ï¼ˆB-portalï¼‰

3. **æ£€æŸ¥æ—¥å¿—ï¼š**
   ```bash
   pm2 logs task-platform-api
   ```

---

## ğŸ”„ åç»­æ›´æ–°ä»£ç æµç¨‹

### æœ¬åœ°ä¿®æ”¹ä»£ç åï¼š

```bash
# 1. æäº¤æ›´æ”¹
git add .
git commit -m "æ›´æ–°æè¿°"
git push origin main
```

### æœåŠ¡å™¨ä¸Šæ›´æ–°ï¼š

```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh root@64.176.83.204

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/task-platform

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# å¦‚æœæœ‰æ–°çš„ä¾èµ–
cd backend && npm install
cd ../frontend/a-portal && npm install
cd ../b-portal && npm install

# é‡æ–°æ„å»º
cd backend && npm run build
cd ../frontend/a-portal && npm run build
cd ../frontend/b-portal && npm run build

# é‡å¯æœåŠ¡
pm2 restart task-platform-api
```

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### 1. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥ MySQL æœåŠ¡
systemctl status mysql

# æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
mysql -u root -p
SHOW DATABASES;

# æ£€æŸ¥ç”¨æˆ·æƒé™
SELECT User, Host FROM mysql.user WHERE User='task_user';
```

### 2. PM2 æœåŠ¡æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs task-platform-api --lines 100

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tulpn | grep 3000

# æ‰‹åŠ¨æµ‹è¯•å¯åŠ¨
cd /opt/task-platform/backend
node dist/server.js
```

### 3. å‰ç«¯æ„å»ºå¤±è´¥
```bash
# æ£€æŸ¥ Node.js ç‰ˆæœ¬ï¼ˆéœ€è¦ 18+ï¼‰
node --version

# æ¸…ç†å¹¶é‡æ–°å®‰è£…
rm -rf node_modules package-lock.json
npm install
npm run build
```

### 4. Nginx 403 é”™è¯¯
```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /opt/task-platform/frontend/*/dist

# ä¿®æ”¹æƒé™
chmod -R 755 /opt/task-platform/frontend
```

---

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] SSH ç™»å½•æœåŠ¡å™¨
- [ ] å…‹éš†ä»“åº“
- [ ] å®‰è£…åç«¯ä¾èµ–
- [ ] å®‰è£…å‰ç«¯ä¾èµ–ï¼ˆA-portalï¼‰
- [ ] å®‰è£…å‰ç«¯ä¾èµ–ï¼ˆB-portalï¼‰
- [ ] é…ç½® `.env` æ–‡ä»¶
- [ ] è¿è¡Œæ•°æ®åº“è¿ç§»
- [ ] æ„å»ºåç«¯
- [ ] æ„å»ºå‰ç«¯ A-portal
- [ ] æ„å»ºå‰ç«¯ B-portal
- [ ] å¯åŠ¨ PM2 æœåŠ¡
- [ ] é…ç½® Nginx
- [ ] æµ‹è¯•è®¿é—®
- [ ] è®¾ç½®å¼€æœºè‡ªå¯

---

## ğŸ‰ å®Œæˆï¼

éƒ¨ç½²å®Œæˆåï¼Œä½ çš„é¡¹ç›®åº”è¯¥å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®ï¼š
- A-portalï¼š`http://ä½ çš„æœåŠ¡å™¨IP`
- B-portalï¼š`http://ä½ çš„æœåŠ¡å™¨IP:8080`
- APIï¼š`http://ä½ çš„æœåŠ¡å™¨IP/api`

