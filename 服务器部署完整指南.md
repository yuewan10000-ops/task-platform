# æœåŠ¡å™¨éƒ¨ç½²å®Œæ•´æŒ‡å—

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### 1. ç¡®è®¤æœåŠ¡å™¨ç¯å¢ƒ

- [x] æœåŠ¡å™¨ IPï¼š64.176.83.204
- [ ] Node.js 18+ å·²å®‰è£…
- [ ] MySQL å·²å®‰è£…å¹¶è¿è¡Œ
- [ ] Nginx å·²å®‰è£…
- [ ] PM2 å·²å®‰è£…ï¼ˆå¯é€‰ï¼Œæ¨èï¼‰

### 2. æ£€æŸ¥æœåŠ¡å™¨ç¯å¢ƒ

```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh root@64.176.83.204

# æ£€æŸ¥ Node.js ç‰ˆæœ¬
node --version
# éœ€è¦ 18 æˆ–æ›´é«˜ç‰ˆæœ¬

# æ£€æŸ¥ npm
npm --version

# æ£€æŸ¥ MySQL
systemctl status mysql

# æ£€æŸ¥ Nginx
systemctl status nginx
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1ï¼šå…‹éš†ä»“åº“

```bash
# è¿›å…¥ /opt ç›®å½•
cd /opt

# å…‹éš†ä»“åº“
git clone https://github.com/yuewan10000-ops/task-platform.git

# è¿›å…¥é¡¹ç›®ç›®å½•
cd task-platform
```

### æ­¥éª¤ 2ï¼šä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x deploy.sh

# è¿è¡Œéƒ¨ç½²è„šæœ¬
bash deploy.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
- âœ… æ£€æŸ¥ç¯å¢ƒ
- âœ… å®‰è£…ä¾èµ–
- âœ… ç”Ÿæˆ Prisma Client
- âœ… è¿è¡Œæ•°æ®åº“è¿ç§»
- âœ… æ„å»ºå‰åç«¯é¡¹ç›®

### æ­¥éª¤ 3ï¼šæ‰‹åŠ¨éƒ¨ç½²ï¼ˆå¦‚æœè„šæœ¬å¤±è´¥ï¼‰

#### 3.1 å®‰è£…åç«¯ä¾èµ–

```bash
cd /opt/task-platform/backend
npm install
```

#### 3.2 å®‰è£…å‰ç«¯ä¾èµ–

```bash
# A-portal
cd /opt/task-platform/frontend/a-portal
npm install

# B-portal
cd /opt/task-platform/frontend/b-portal
npm install
```

#### 3.3 é…ç½®ç¯å¢ƒå˜é‡

```bash
cd /opt/task-platform/backend

# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp env.example .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡
nano .env
```

**å¿…é¡»é…ç½®çš„å†…å®¹ï¼š**

```env
# æ•°æ®åº“è¿æ¥ï¼ˆæ›¿æ¢ä¸ºä½ çš„å®é™…å¯†ç ï¼‰
DATABASE_URL="mysql://task_user:ä½ çš„æ•°æ®åº“å¯†ç @localhost:3306/task_db"

# JWT å¯†é’¥ï¼ˆç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ï¼‰
JWT_SECRET="ä½ çš„JWTå¯†é’¥_å»ºè®®ä½¿ç”¨éšæœºå­—ç¬¦ä¸²_è‡³å°‘32ä½"

# ç®¡ç†å‘˜è´¦å·ï¼ˆé»˜è®¤ï¼‰
ADMIN_ACCOUNT="admin"

# ç®¡ç†å‘˜ç™»å½•å¯†ç 
ADMIN_LOGIN_PASSWORD="ä½ çš„ç®¡ç†å‘˜ç™»å½•å¯†ç "

# ç®¡ç†å‘˜æ”¯ä»˜å¯†ç 
ADMIN_PAY_PASSWORD="ä½ çš„ç®¡ç†å‘˜æ”¯ä»˜å¯†ç "
```

**ç”Ÿæˆéšæœº JWT_SECRETï¼š**
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨ openssl
openssl rand -base64 32

# æ–¹æ³•2ï¼šä½¿ç”¨ Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

**ä¿å­˜å¹¶é€€å‡ºï¼š** `Ctrl+X` â†’ `Y` â†’ `Enter`

#### 3.4 è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
cd /opt/task-platform/backend

# ç”Ÿæˆ Prisma Client
npx prisma generate

# è¿è¡Œæ•°æ®åº“è¿ç§»
npx prisma migrate deploy

# å¦‚æœ migrate deploy å¤±è´¥ï¼Œå°è¯•ï¼š
npx prisma db push
```

#### 3.5 æ„å»ºé¡¹ç›®

```bash
# æ„å»ºåç«¯
cd /opt/task-platform/backend
npm run build

# æ„å»ºå‰ç«¯ A-portal
cd /opt/task-platform/frontend/a-portal
npm run build

# æ„å»ºå‰ç«¯ B-portal
cd /opt/task-platform/frontend/b-portal
npm run build
```

### æ­¥éª¤ 4ï¼šå¯åŠ¨åç«¯æœåŠ¡

#### ä½¿ç”¨ PM2ï¼ˆæ¨èï¼‰

```bash
# å®‰è£… PM2ï¼ˆå¦‚æœè¿˜æ²¡å®‰è£…ï¼‰
npm install -g pm2

# å¯åŠ¨æœåŠ¡
cd /opt/task-platform/backend
pm2 start dist/server.js --name task-platform-api

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs task-platform-api

# ä¿å­˜ PM2 é…ç½®
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
# æ‰§è¡Œä¸Šé¢å‘½ä»¤è¾“å‡ºçš„å‘½ä»¤ï¼ˆé€šå¸¸æ˜¯ sudo env PATH=...ï¼‰
```

#### æˆ–ä½¿ç”¨ systemdï¼ˆå¯é€‰ï¼‰

åˆ›å»º systemd æœåŠ¡æ–‡ä»¶ï¼š

```bash
sudo nano /etc/systemd/system/task-platform.service
```

å†…å®¹ï¼š

```ini
[Unit]
Description=Task Platform API
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/task-platform/backend
ExecStart=/usr/bin/node dist/server.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
```

å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡ï¼š

```bash
sudo systemctl daemon-reload
sudo systemctl enable task-platform
sudo systemctl start task-platform
sudo systemctl status task-platform
```

### æ­¥éª¤ 5ï¼šé…ç½® Nginx

#### 5.1 åˆ›å»º Nginx é…ç½®

```bash
sudo nano /etc/nginx/sites-available/task-platform
```

#### 5.2 A-portal é…ç½®ï¼ˆä¸»ç«™ç‚¹ï¼‰

```nginx
server {
    listen 80;
    server_name 64.176.83.204;  # æ›¿æ¢ä¸ºä½ çš„åŸŸåæˆ–IP

    # A-portal å‰ç«¯
    root /opt/task-platform/frontend/a-portal/dist;
    index index.html;

    # å‰ç«¯è·¯ç”±
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API ä»£ç†
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 5.3 B-portal é…ç½®ï¼ˆç®¡ç†åå°ï¼‰

```nginx
server {
    listen 8080;
    server_name 64.176.83.204;

    # B-portal å‰ç«¯
    root /opt/task-platform/frontend/b-portal/dist;
    index index.html;

    # å‰ç«¯è·¯ç”±
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API ä»£ç†
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 5.4 å¯ç”¨é…ç½®

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/task-platform /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½ Nginx
sudo systemctl reload nginx
```

### æ­¥éª¤ 6ï¼šéªŒè¯éƒ¨ç½²

#### 6.1 æ£€æŸ¥åç«¯æœåŠ¡

```bash
# æ£€æŸ¥ PM2 çŠ¶æ€
pm2 status

# æ£€æŸ¥ç«¯å£
netstat -tulpn | grep 3000

# æµ‹è¯• APIï¼ˆå¦‚æœæœ‰å¥åº·æ£€æŸ¥æ¥å£ï¼‰
curl http://localhost:3000/api/health
```

#### 6.2 æ£€æŸ¥å‰ç«¯

- **A-portalï¼š** è®¿é—® `http://64.176.83.204`
- **B-portalï¼š** è®¿é—® `http://64.176.83.204:8080`

#### 6.3 æ£€æŸ¥æ—¥å¿—

```bash
# PM2 æ—¥å¿—
pm2 logs task-platform-api

# Nginx æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log
```

---

## ğŸ”„ åç»­æ›´æ–°ä»£ç 

### æœ¬åœ°ä¿®æ”¹ä»£ç åï¼š

```bash
# 1. æäº¤æ›´æ”¹
git add .
git commit -m "æ›´æ–°æè¿°"
git push origin main
```

### æœåŠ¡å™¨ä¸Šæ›´æ–°ï¼š

```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh root@64.176.83.204

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/task-platform

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# å¦‚æœæœ‰æ–°çš„ä¾èµ–ï¼Œé‡æ–°å®‰è£…
cd backend && npm install
cd ../frontend/a-portal && npm install
cd ../b-portal && npm install

# é‡æ–°æ„å»º
cd backend && npm run build
cd ../frontend/a-portal && npm run build
cd ../frontend/b-portal && npm run build

# é‡å¯æœåŠ¡
pm2 restart task-platform-api

# é‡æ–°åŠ è½½ Nginxï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo systemctl reload nginx
```

---

## ğŸ†˜ å¸¸è§é—®é¢˜æ’æŸ¥

### 1. æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ MySQL æœåŠ¡
systemctl status mysql

# æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
mysql -u root -p
SHOW DATABASES;
USE task_db;
SHOW TABLES;

# æ£€æŸ¥ç”¨æˆ·æƒé™
SELECT User, Host FROM mysql.user WHERE User='task_user';

# å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºç”¨æˆ·
CREATE USER 'task_user'@'localhost' IDENTIFIED BY 'ä½ çš„å¯†ç ';
GRANT ALL PRIVILEGES ON task_db.* TO 'task_user'@'localhost';
FLUSH PRIVILEGES;
```

### 2. PM2 æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs task-platform-api --lines 100

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tulpn | grep 3000
lsof -i :3000

# æ‰‹åŠ¨æµ‹è¯•å¯åŠ¨
cd /opt/task-platform/backend
node dist/server.js
```

### 3. å‰ç«¯æ„å»ºå¤±è´¥

```bash
# æ£€æŸ¥ Node.js ç‰ˆæœ¬ï¼ˆéœ€è¦ 18+ï¼‰
node --version

# æ¸…ç†å¹¶é‡æ–°å®‰è£…
cd /opt/task-platform/frontend/a-portal
rm -rf node_modules package-lock.json
npm install
npm run build
```

### 4. Nginx 403 æˆ– 404 é”™è¯¯

```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /opt/task-platform/frontend/*/dist

# ä¿®æ”¹æƒé™
chmod -R 755 /opt/task-platform/frontend
chown -R www-data:www-data /opt/task-platform/frontend

# æ£€æŸ¥ Nginx é…ç½®
sudo nginx -t
```

### 5. API è¯·æ±‚å¤±è´¥

```bash
# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
pm2 status

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
sudo ufw allow 3000/tcp

# æ£€æŸ¥ Nginx ä»£ç†é…ç½®
sudo nginx -t
```

---

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] SSH ç™»å½•æœåŠ¡å™¨
- [ ] å…‹éš†ä»“åº“åˆ° `/opt/task-platform`
- [ ] è¿è¡Œéƒ¨ç½²è„šæœ¬æˆ–æ‰‹åŠ¨éƒ¨ç½²
- [ ] é…ç½® `.env` æ–‡ä»¶
- [ ] è¿è¡Œæ•°æ®åº“è¿ç§»
- [ ] æ„å»ºåç«¯é¡¹ç›®
- [ ] æ„å»ºå‰ç«¯ A-portal
- [ ] æ„å»ºå‰ç«¯ B-portal
- [ ] å¯åŠ¨ PM2 æœåŠ¡
- [ ] é…ç½® Nginx
- [ ] æµ‹è¯• A-portal è®¿é—®
- [ ] æµ‹è¯• B-portal è®¿é—®
- [ ] æµ‹è¯• API æ¥å£
- [ ] è®¾ç½® PM2 å¼€æœºè‡ªå¯

---

## ğŸ‰ éƒ¨ç½²å®Œæˆï¼

éƒ¨ç½²å®Œæˆåï¼Œä½ çš„é¡¹ç›®åº”è¯¥å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®ï¼š

- **A-portalï¼ˆç”¨æˆ·ç«¯ï¼‰ï¼š** `http://64.176.83.204`
- **B-portalï¼ˆç®¡ç†ç«¯ï¼‰ï¼š** `http://64.176.83.204:8080`
- **APIï¼š** `http://64.176.83.204/api`

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. PM2 æ—¥å¿—ï¼š`pm2 logs task-platform-api`
2. Nginx æ—¥å¿—ï¼š`sudo tail -f /var/log/nginx/error.log`
3. ç³»ç»Ÿæ—¥å¿—ï¼š`journalctl -u task-platform`ï¼ˆå¦‚æœä½¿ç”¨ systemdï¼‰

