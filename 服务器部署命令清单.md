# æœåŠ¡å™¨éƒ¨ç½²å‘½ä»¤æ¸…å•

## ğŸ“‹ å¿«é€Ÿéƒ¨ç½²ï¼ˆå¤åˆ¶ç²˜è´´æ‰§è¡Œï¼‰

### æ–¹å¼ä¸€ï¼šä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# 1. SSH ç™»å½•æœåŠ¡å™¨
ssh root@64.176.83.204

# 2. ä¸‹è½½å¹¶æ‰§è¡Œéƒ¨ç½²è„šæœ¬
cd /opt
git clone https://github.com/yuewan10000-ops/task-platform.git
cd task-platform
chmod +x deploy.sh
bash deploy.sh
```

---

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤ï¼ˆé€æ­¥æ‰§è¡Œï¼‰

#### æ­¥éª¤ 1: å…‹éš†ä»“åº“

```bash
cd /opt
git clone https://github.com/yuewan10000-ops/task-platform.git
cd task-platform
```

#### æ­¥éª¤ 2: å®‰è£…åç«¯ä¾èµ–

```bash
cd backend
npm install
cd ..
```

#### æ­¥éª¤ 3: å®‰è£…å‰ç«¯ä¾èµ–

```bash
# A-portal
cd frontend/a-portal
npm install
cd ../..

# B-portal
cd frontend/b-portal
npm install
cd ../..
```

#### æ­¥éª¤ 4: é…ç½®ç¯å¢ƒå˜é‡

```bash
cd backend
cp env.example .env
nano .env
```

**å¿…é¡»é…ç½®çš„å†…å®¹ï¼š**
```env
DATABASE_URL="mysql://task_user:ä½ çš„æ•°æ®åº“å¯†ç @localhost:3306/task_db"
JWT_SECRET="ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²"
ADMIN_ACCOUNT="admin"
ADMIN_LOGIN_PASSWORD="ä½ çš„ç®¡ç†å‘˜ç™»å½•å¯†ç "
ADMIN_PAY_PASSWORD="ä½ çš„ç®¡ç†å‘˜æ”¯ä»˜å¯†ç "
```

**ç”Ÿæˆéšæœº JWT_SECRETï¼š**
```bash
openssl rand -base64 32
```

ä¿å­˜ï¼š`Ctrl+X` â†’ `Y` â†’ `Enter`

#### æ­¥éª¤ 5: ç”Ÿæˆ Prisma Client å¹¶è¿è¡Œè¿ç§»

```bash
cd backend
npx prisma generate
npx prisma migrate deploy
cd ..
```

#### æ­¥éª¤ 6: æ„å»ºé¡¹ç›®

```bash
# æ„å»ºåç«¯
cd backend
npm run build
cd ..

# æ„å»º A-portal
cd frontend/a-portal
npm run build
cd ../..

# æ„å»º B-portal
cd frontend/b-portal
npm run build
cd ../..
```

#### æ­¥éª¤ 7: å¯åŠ¨æœåŠ¡

```bash
# å®‰è£… PM2ï¼ˆå¦‚æœè¿˜æ²¡å®‰è£…ï¼‰
npm install -g pm2

# å¯åŠ¨æœåŠ¡
cd /opt/task-platform/backend
pm2 start dist/server.js --name task-platform-api

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs task-platform-api

# ä¿å­˜é…ç½®
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
# æ‰§è¡Œä¸Šé¢å‘½ä»¤è¾“å‡ºçš„å‘½ä»¤
```

#### æ­¥éª¤ 8: é…ç½® Nginx

```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo nano /etc/nginx/sites-available/task-platform
```

**A-portal é…ç½®ï¼ˆä¸»ç«™ç‚¹ï¼Œç«¯å£ 80ï¼‰ï¼š**
```nginx
server {
    listen 80;
    server_name 64.176.83.204;

    root /opt/task-platform/frontend/a-portal/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

**B-portal é…ç½®ï¼ˆç®¡ç†åå°ï¼Œç«¯å£ 8080ï¼‰ï¼š**
```nginx
server {
    listen 8080;
    server_name 64.176.83.204;

    root /opt/task-platform/frontend/b-portal/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

**å¯ç”¨é…ç½®ï¼š**
```bash
# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/task-platform /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½ Nginx
sudo systemctl reload nginx
```

---

## ğŸ” éªŒè¯éƒ¨ç½²

### æ£€æŸ¥åç«¯æœåŠ¡

```bash
# æ£€æŸ¥ PM2 çŠ¶æ€
pm2 status

# æ£€æŸ¥ç«¯å£
netstat -tulpn | grep 3000

# æµ‹è¯• API
curl http://localhost:3000/api/health
```

### æ£€æŸ¥å‰ç«¯

- **A-portalï¼š** æµè§ˆå™¨è®¿é—® `http://64.176.83.204`
- **B-portalï¼š** æµè§ˆå™¨è®¿é—® `http://64.176.83.204:8080`

### æŸ¥çœ‹æ—¥å¿—

```bash
# PM2 æ—¥å¿—
pm2 logs task-platform-api

# Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# Nginx è®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/access.log
```

---

## ğŸ”„ æ›´æ–°ä»£ç 

### æœ¬åœ°ä¿®æ”¹ä»£ç åï¼š

```bash
git add .
git commit -m "æ›´æ–°æè¿°"
git push origin main
```

### æœåŠ¡å™¨ä¸Šæ›´æ–°ï¼š

```bash
cd /opt/task-platform
git pull origin main

# å¦‚æœæœ‰æ–°çš„ä¾èµ–
cd backend && npm install
cd ../frontend/a-portal && npm install
cd ../b-portal && npm install

# é‡æ–°æ„å»º
cd backend && npm run build
cd ../frontend/a-portal && npm run build
cd ../frontend/b-portal && npm run build

# é‡å¯æœåŠ¡
pm2 restart task-platform-api
```

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### 1. æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ MySQL æœåŠ¡
systemctl status mysql

# ç™»å½• MySQL
mysql -u root -p

# æ£€æŸ¥æ•°æ®åº“
SHOW DATABASES;
USE task_db;
SHOW TABLES;

# å¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ï¼Œåˆ›å»º
CREATE DATABASE task_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºç”¨æˆ·
CREATE USER 'task_user'@'localhost' IDENTIFIED BY 'ä½ çš„å¯†ç ';
GRANT ALL PRIVILEGES ON task_db.* TO 'task_user'@'localhost';
FLUSH PRIVILEGES;
```

### 2. PM2 æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs task-platform-api --lines 100

# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :3000

# æ‰‹åŠ¨æµ‹è¯•
cd /opt/task-platform/backend
node dist/server.js
```

### 3. Nginx 403 é”™è¯¯

```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /opt/task-platform/frontend/*/dist

# ä¿®æ”¹æƒé™
chmod -R 755 /opt/task-platform/frontend
chown -R www-data:www-data /opt/task-platform/frontend
```

### 4. ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tulpn | grep 3000

# æ€æ­»å ç”¨è¿›ç¨‹
kill -9 <PID>

# æˆ–ä½¿ç”¨ PM2 é‡å¯
pm2 restart task-platform-api
```

---

## ğŸ“ ä¸€é”®æ‰§è¡Œè„šæœ¬

å¦‚æœä½ æƒ³ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰å‘½ä»¤ï¼Œå¯ä»¥å¤åˆ¶ä»¥ä¸‹å†…å®¹ä¿å­˜ä¸º `deploy-all.sh`ï¼š

```bash
#!/bin/bash
set -e

echo "å¼€å§‹éƒ¨ç½²..."

# å…‹éš†/æ›´æ–°ä»£ç 
cd /opt
if [ -d "task-platform" ]; then
    cd task-platform
    git pull origin main
else
    git clone https://github.com/yuewan10000-ops/task-platform.git
    cd task-platform
fi

# å®‰è£…ä¾èµ–
cd backend && npm install && cd ..
cd frontend/a-portal && npm install && cd ../..
cd frontend/b-portal && npm install && cd ../..

# é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
cd backend
if [ ! -f ".env" ]; then
    cp env.example .env
    echo "âš  è¯·ç¼–è¾‘ .env æ–‡ä»¶é…ç½®æ•°æ®åº“ç­‰ä¿¡æ¯"
    nano .env
fi
cd ..

# ç”Ÿæˆ Prisma Client
cd backend
npx prisma generate
npx prisma migrate deploy || npx prisma db push
cd ..

# æ„å»º
cd backend && npm run build && cd ..
cd frontend/a-portal && npm run build && cd ../..
cd frontend/b-portal && npm run build && cd ../..

# å¯åŠ¨æœåŠ¡
cd backend
pm2 start dist/server.js --name task-platform-api || pm2 restart task-platform-api
pm2 save

echo "éƒ¨ç½²å®Œæˆï¼"
```

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
chmod +x deploy-all.sh
bash deploy-all.sh
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] SSH ç™»å½•æœåŠ¡å™¨
- [ ] å…‹éš†ä»“åº“åˆ° `/opt/task-platform`
- [ ] å®‰è£…åç«¯ä¾èµ–
- [ ] å®‰è£…å‰ç«¯ A-portal ä¾èµ–
- [ ] å®‰è£…å‰ç«¯ B-portal ä¾èµ–
- [ ] é…ç½® `.env` æ–‡ä»¶
- [ ] ç”Ÿæˆ Prisma Client
- [ ] è¿è¡Œæ•°æ®åº“è¿ç§»
- [ ] æ„å»ºåç«¯
- [ ] æ„å»ºå‰ç«¯ A-portal
- [ ] æ„å»ºå‰ç«¯ B-portal
- [ ] å¯åŠ¨ PM2 æœåŠ¡
- [ ] é…ç½® Nginx
- [ ] æµ‹è¯•è®¿é—®
- [ ] è®¾ç½®å¼€æœºè‡ªå¯

---

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œä½ çš„é¡¹ç›®å°±å¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š
- **A-portalï¼š** http://64.176.83.204
- **B-portalï¼š** http://64.176.83.204:8080

