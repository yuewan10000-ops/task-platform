# æœåŠ¡å™¨éƒ¨ç½²æ“ä½œæŒ‡å—

## ğŸ¯ ç›®æ ‡

åœ¨æœåŠ¡å™¨ `64.176.83.204` ä¸Šéƒ¨ç½²ä»»åŠ¡å¹³å°é¡¹ç›®ã€‚

---

## ğŸ“‹ å‡†å¤‡å·¥ä½œ

### 1. ç¡®è®¤æœåŠ¡å™¨ç¯å¢ƒ

åœ¨å¼€å§‹ä¹‹å‰ï¼Œç¡®è®¤æœåŠ¡å™¨å·²å®‰è£…ï¼š
- âœ… Node.js 18+ 
- âœ… npm
- âœ… MySQL
- âœ… Nginxï¼ˆå¯é€‰ï¼Œç”¨äºåå‘ä»£ç†ï¼‰

### 2. æ£€æŸ¥ç¯å¢ƒå‘½ä»¤

```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh root@64.176.83.204

# æ£€æŸ¥ Node.js
node --version
# åº”è¯¥æ˜¾ç¤º v18.x.x æˆ–æ›´é«˜

# æ£€æŸ¥ npm
npm --version

# æ£€æŸ¥ MySQL
systemctl status mysql
```

---

## ğŸš€ éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šä½¿ç”¨è‡ªåŠ¨è„šæœ¬ï¼ˆæœ€ç®€å•ï¼‰

#### æ­¥éª¤ 1: SSH ç™»å½•æœåŠ¡å™¨

```bash
ssh root@64.176.83.204
```

#### æ­¥éª¤ 2: å…‹éš†ä»“åº“å¹¶è¿è¡Œè„šæœ¬

```bash
cd /opt
git clone https://github.com/yuewan10000-ops/task-platform.git
cd task-platform
chmod +x deploy.sh
bash deploy.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆå¤§éƒ¨åˆ†å·¥ä½œï¼Œä½ åªéœ€è¦ï¼š
1. é…ç½® `.env` æ–‡ä»¶ï¼ˆè„šæœ¬ä¼šæç¤ºï¼‰
2. å¯åŠ¨ PM2 æœåŠ¡
3. é…ç½® Nginx

---

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤ï¼ˆé€æ­¥æ‰§è¡Œï¼‰

#### æ­¥éª¤ 1: å…‹éš†ä»“åº“

```bash
cd /opt
git clone https://github.com/yuewan10000-ops/task-platform.git
cd task-platform
```

#### æ­¥éª¤ 2: å®‰è£…åç«¯ä¾èµ–

```bash
cd backend
npm install
cd ..
```

#### æ­¥éª¤ 3: å®‰è£…å‰ç«¯ä¾èµ–

```bash
# A-portal
cd frontend/a-portal
npm install
cd ../..

# B-portal
cd frontend/b-portal
npm install
cd ../..
```

#### æ­¥éª¤ 4: é…ç½®ç¯å¢ƒå˜é‡

```bash
cd backend
cp env.example .env
nano .env
```

**å¿…é¡»é…ç½®ä»¥ä¸‹å†…å®¹ï¼š**

```env
# æ•°æ®åº“è¿æ¥ï¼ˆæ›¿æ¢ä¸ºä½ çš„å®é™…å¯†ç ï¼‰
DATABASE_URL="mysql://task_user:ä½ çš„æ•°æ®åº“å¯†ç @localhost:3306/task_db"

# JWT å¯†é’¥ï¼ˆç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼‰
JWT_SECRET="ä½ çš„JWTå¯†é’¥_å»ºè®®ä½¿ç”¨éšæœºå­—ç¬¦ä¸²_è‡³å°‘32ä½"

# ç®¡ç†å‘˜è´¦å·
ADMIN_ACCOUNT="admin"

# ç®¡ç†å‘˜ç™»å½•å¯†ç 
ADMIN_LOGIN_PASSWORD="ä½ çš„ç®¡ç†å‘˜ç™»å½•å¯†ç "

# ç®¡ç†å‘˜æ”¯ä»˜å¯†ç 
ADMIN_PAY_PASSWORD="ä½ çš„ç®¡ç†å‘˜æ”¯ä»˜å¯†ç "
```

**ç”Ÿæˆéšæœº JWT_SECRETï¼š**
```bash
openssl rand -base64 32
```

ä¿å­˜æ–‡ä»¶ï¼š`Ctrl+X` â†’ `Y` â†’ `Enter`

#### æ­¥éª¤ 5: ç”Ÿæˆ Prisma Client å¹¶è¿è¡Œè¿ç§»

```bash
cd backend
npx prisma generate
npx prisma migrate deploy
# å¦‚æœ migrate deploy å¤±è´¥ï¼Œå°è¯•ï¼š
# npx prisma db push
cd ..
```

#### æ­¥éª¤ 6: æ„å»ºé¡¹ç›®

```bash
# æ„å»ºåç«¯
cd backend
npm run build
cd ..

# æ„å»º A-portal
cd frontend/a-portal
npm run build
cd ../..

# æ„å»º B-portal
cd frontend/b-portal
npm run build
cd ../..
```

#### æ­¥éª¤ 7: å¯åŠ¨åç«¯æœåŠ¡

```bash
# å®‰è£… PM2ï¼ˆå¦‚æœè¿˜æ²¡å®‰è£…ï¼‰
npm install -g pm2

# å¯åŠ¨æœåŠ¡
cd /opt/task-platform/backend
pm2 start dist/server.js --name task-platform-api

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs task-platform-api

# ä¿å­˜é…ç½®
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
# æ‰§è¡Œä¸Šé¢å‘½ä»¤è¾“å‡ºçš„å‘½ä»¤ï¼ˆé€šå¸¸æ˜¯ sudo env PATH=...ï¼‰
```

#### æ­¥éª¤ 8: é…ç½® Nginx

```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo nano /etc/nginx/sites-available/task-platform
```

**å¤åˆ¶ä»¥ä¸‹é…ç½®ï¼š**

```nginx
# A-portalï¼ˆä¸»ç«™ç‚¹ï¼Œç«¯å£ 80ï¼‰
server {
    listen 80;
    server_name 64.176.83.204;

    root /opt/task-platform/frontend/a-portal/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# B-portalï¼ˆç®¡ç†åå°ï¼Œç«¯å£ 8080ï¼‰
server {
    listen 8080;
    server_name 64.176.83.204;

    root /opt/task-platform/frontend/b-portal/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

**å¯ç”¨é…ç½®ï¼š**

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/task-platform /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½ Nginx
sudo systemctl reload nginx
```

---

## âœ… éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥åç«¯æœåŠ¡

```bash
# æŸ¥çœ‹ PM2 çŠ¶æ€
pm2 status

# åº”è¯¥çœ‹åˆ° task-platform-api çŠ¶æ€ä¸º online

# æŸ¥çœ‹æ—¥å¿—
pm2 logs task-platform-api

# æ£€æŸ¥ç«¯å£
netstat -tulpn | grep 3000
```

### 2. æ£€æŸ¥å‰ç«¯

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š
- **A-portalï¼š** `http://64.176.83.204`
- **B-portalï¼š** `http://64.176.83.204:8080`

### 3. æ£€æŸ¥ Nginx

```bash
# æŸ¥çœ‹ Nginx çŠ¶æ€
sudo systemctl status nginx

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# æŸ¥çœ‹è®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/access.log
```

---

## ğŸ”„ æ›´æ–°ä»£ç 

### æœ¬åœ°ä¿®æ”¹ä»£ç åï¼š

```bash
git add .
git commit -m "æ›´æ–°æè¿°"
git push origin main
```

### æœåŠ¡å™¨ä¸Šæ›´æ–°ï¼š

```bash
cd /opt/task-platform
git pull origin main

# å¦‚æœæœ‰æ–°çš„ä¾èµ–
cd backend && npm install
cd ../frontend/a-portal && npm install
cd ../b-portal && npm install

# é‡æ–°æ„å»º
cd backend && npm run build
cd ../frontend/a-portal && npm run build
cd ../frontend/b-portal && npm run build

# é‡å¯æœåŠ¡
pm2 restart task-platform-api
```

---

## ğŸ†˜ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶ï¼š** æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œæ—¥å¿—æ˜¾ç¤ºæ•°æ®åº“è¿æ¥é”™è¯¯

**è§£å†³ï¼š**

```bash
# 1. æ£€æŸ¥ MySQL æœåŠ¡
systemctl status mysql

# 2. æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
mysql -u root -p
SHOW DATABASES;

# 3. å¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ï¼Œåˆ›å»º
CREATE DATABASE task_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 4. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
SELECT User, Host FROM mysql.user WHERE User='task_user';

# 5. å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºç”¨æˆ·
CREATE USER 'task_user'@'localhost' IDENTIFIED BY 'ä½ çš„å¯†ç ';
GRANT ALL PRIVILEGES ON task_db.* TO 'task_user'@'localhost';
FLUSH PRIVILEGES;

# 6. æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ DATABASE_URL æ˜¯å¦æ­£ç¡®
cat /opt/task-platform/backend/.env | grep DATABASE_URL
```

### é—®é¢˜ 2: PM2 æœåŠ¡æ— æ³•å¯åŠ¨

**ç—‡çŠ¶ï¼š** `pm2 start` å¤±è´¥æˆ–æœåŠ¡ç«‹å³é€€å‡º

**è§£å†³ï¼š**

```bash
# 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs task-platform-api --lines 100

# 2. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tulpn | grep 3000
lsof -i :3000

# 3. å¦‚æœç«¯å£è¢«å ç”¨ï¼Œæ€æ­»è¿›ç¨‹
kill -9 <PID>

# 4. æ‰‹åŠ¨æµ‹è¯•å¯åŠ¨
cd /opt/task-platform/backend
node dist/server.js

# 5. æ£€æŸ¥ .env æ–‡ä»¶æ˜¯å¦æ­£ç¡®é…ç½®
cat .env
```

### é—®é¢˜ 3: å‰ç«¯é¡µé¢ç©ºç™½æˆ– 404

**ç—‡çŠ¶ï¼š** æµè§ˆå™¨è®¿é—®æ˜¾ç¤ºç©ºç™½é¡µé¢æˆ– 404

**è§£å†³ï¼š**

```bash
# 1. æ£€æŸ¥ dist ç›®å½•æ˜¯å¦å­˜åœ¨
ls -la /opt/task-platform/frontend/a-portal/dist
ls -la /opt/task-platform/frontend/b-portal/dist

# 2. æ£€æŸ¥æ–‡ä»¶æƒé™
chmod -R 755 /opt/task-platform/frontend
chown -R www-data:www-data /opt/task-platform/frontend

# 3. æ£€æŸ¥ Nginx é…ç½®
sudo nginx -t

# 4. æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

### é—®é¢˜ 4: API è¯·æ±‚å¤±è´¥

**ç—‡çŠ¶ï¼š** å‰ç«¯æ— æ³•è¿æ¥åˆ°åç«¯ API

**è§£å†³ï¼š**

```bash
# 1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
pm2 status

# 2. æµ‹è¯• API è¿æ¥
curl http://localhost:3000/api/health

# 3. æ£€æŸ¥ Nginx ä»£ç†é…ç½®
sudo cat /etc/nginx/sites-available/task-platform | grep proxy_pass

# 4. æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
sudo ufw allow 3000/tcp
```

### é—®é¢˜ 5: Prisma è¿ç§»å¤±è´¥

**ç—‡çŠ¶ï¼š** `npx prisma migrate deploy` å¤±è´¥

**è§£å†³ï¼š**

```bash
# 1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
mysql -u task_user -p task_db

# 2. å°è¯•ä½¿ç”¨ db pushï¼ˆå¼€å‘ç¯å¢ƒï¼‰
cd /opt/task-platform/backend
npx prisma db push

# 3. æ£€æŸ¥ Prisma schema
cat prisma/schema.prisma

# 4. é‡æ–°ç”Ÿæˆ Prisma Client
npx prisma generate
```

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] SSH ç™»å½•æœåŠ¡å™¨æˆåŠŸ
- [ ] å…‹éš†ä»“åº“åˆ° `/opt/task-platform`
- [ ] å®‰è£…åç«¯ä¾èµ–å®Œæˆ
- [ ] å®‰è£…å‰ç«¯ A-portal ä¾èµ–å®Œæˆ
- [ ] å®‰è£…å‰ç«¯ B-portal ä¾èµ–å®Œæˆ
- [ ] é…ç½® `.env` æ–‡ä»¶ï¼ˆæ•°æ®åº“ã€JWTã€ç®¡ç†å‘˜å¯†ç ï¼‰
- [ ] ç”Ÿæˆ Prisma Client æˆåŠŸ
- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸ
- [ ] åç«¯æ„å»ºæˆåŠŸ
- [ ] å‰ç«¯ A-portal æ„å»ºæˆåŠŸ
- [ ] å‰ç«¯ B-portal æ„å»ºæˆåŠŸ
- [ ] PM2 æœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] Nginx é…ç½®å®Œæˆ
- [ ] A-portal å¯ä»¥è®¿é—®
- [ ] B-portal å¯ä»¥è®¿é—®
- [ ] API æ¥å£æ­£å¸¸

---

## ğŸ‰ éƒ¨ç½²å®Œæˆï¼

éƒ¨ç½²æˆåŠŸåï¼Œä½ çš„é¡¹ç›®å¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š

- **A-portalï¼ˆç”¨æˆ·ç«¯ï¼‰ï¼š** `http://64.176.83.204`
- **B-portalï¼ˆç®¡ç†ç«¯ï¼‰ï¼š** `http://64.176.83.204:8080`
- **API æ¥å£ï¼š** `http://64.176.83.204/api`

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹ PM2 æ—¥å¿—ï¼š`pm2 logs task-platform-api`
2. æŸ¥çœ‹ Nginx æ—¥å¿—ï¼š`sudo tail -f /var/log/nginx/error.log`
3. æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š`pm2 status` å’Œ `systemctl status nginx`

